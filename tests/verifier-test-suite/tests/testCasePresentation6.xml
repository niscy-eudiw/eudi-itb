<?xml version="1.0" encoding="UTF-8"?>
<testcase id="verify_pid_mdoc_no_trusted_iaca_cert" xmlns="http://www.gitb.com/tdl/v1/" xmlns:gitb="http://www.gitb.com/core/v1/">
    <metadata>
        <gitb:name>Remote presentation with mdoc authentication and a not trusted IACA Certificate</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>This test case verifies that a remote reader warns the user when a IACA Certificate is not trusted</gitb:description>
        <gitb:specification>
            <gitb:reference>Remote_Presentation_7</gitb:reference>
        </gitb:specification>
        <gitb:documentation><![CDATA[
            <h4>Preconditions</h4>
            <ol style="list-style-type: lower-alpha;">
            <li>The user of the remote reader has shared its url to&nbsp;the wallet user</li>
            <li>The wallet has any document signed by a&nbsp;Document Signer Certificate that is issued by an&nbsp;IACA Certificate that is not on the ETSI trusted&nbsp;certificate list</li>
            </ol>
            <h4>Test steps</h4>
            <ol>
            <li>The wallet user navigates to the url of the remote&nbsp;reader</li>
            <li>The wallet user clicks on a link/scans a QR code to&nbsp;start reading its documents (DCQL)</li>
            <li>The wallet user gives permission to share the&nbsp;document</li>
            <li>The remote reader is verified</li>
            </ol>
            <h4>Expected results</h4>
            <ol>
            <li>The website of the remote reader opens</li>
            <li>The wallet opens and the wallet user is warned that the reader is not trusted. The test case passes either when the process is stopped here or when the user may decide to go on sharing their document</li>
            </ol>
        ]]></gitb:documentation>
    </metadata>
    <actors>
        <gitb:actor id="verifier" name="Verifier" />
        <gitb:actor id="simulatedInitTransaction" name="Simulated Transaction"/>
        <gitb:actor id="wallet" name="Wallet" role="SUT"/>
    </actors>
    <steps>
        <btxn from="simulatedInitTransaction" to="verifier" txnId="t1" handler="HttpMessagingV2"/>
        <process output="nonce" handler="TokenGenerator" operation="uuid"/>

        <assign to="authReqUri{uri}">$SYSTEM{authUri}</assign>

        <assign to="httpHeaders{Content-Type}">"application/json"</assign>
        <assign to="httpHeaders{Accept}">"image/png"</assign>
        <send id="dataReceived" desc="Send valid presentation request" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
            <input name="uri">$DOMAIN{endpointAddress} || "/ui/presentations/v2"</input>
            <input name="method">"POST"</input>
            <input name="body">'{"type":"vp_token","dcql_query":{"credentials":[{"id":"query_0","format":"dc+sd-jwt","meta":{"vct_values":["urn:eudi:pid:1"]}}]},"issuer_chain":"-----BEGIN CERTIFICATE-----\nMIICmzCCAkGgAwIBAgIUcIRBtysIv2tUHZUUW2tCVyE1HD4wCgYIKoZIzj0EAwIw\ngYcxCzAJBgNVBAYTAlVTMRgwFgYDVQQIDA9TdGF0ZSBvZiBVdG9waWExEjAQBgNV\nBAcMCVNhbiBSYW1vbjEaMBgGA1UECgwRT3BlbklEIEZvdW5kYXRpb24xCzAJBgNV\nBAsMAklUMSEwHwYDVQQDDBhjZXJ0aWZpY2F0aW9uLm9wZW5pZC5uZXQwHhcNMjUx\nMDA4MDkxMzQ1WhcNMjYxMDA4MDkxMzQ1WjCBhzELMAkGA1UEBhMCVVMxGDAWBgNV\nBAgMD1N0YXRlIG9mIFV0b3BpYTESMBAGA1UEBwwJU2FuIFJhbW9uMRowGAYDVQQK\nDBFPcGVuSUQgRm91bmRhdGlvbjELMAkGA1UECwwCSVQxITAfBgNVBAMMGGNlcnRp\nZmljYXRpb24ub3BlbmlkLm5ldDBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABJl+\nF1Jhzt/OVFihkGmGVZBbmJxdzNEIEzTk4xEQbbOMYySrhwwVm/dMBzpMq7vVARnR\nbjN7jDbNBXgJ2+ENa++jgYgwgYUwZAYDVR0RBF0wW4IYY2VydGlmaWNhdGlvbi5v\ncGVuaWQubmV0gh1kZW1vLmNlcnRpZmljYXRpb24ub3BlbmlkLm5ldIIgc3RhZ2lu\nZy5jZXJ0aWZpY2F0aW9uLm9wZW5pZC5uZXQwHQYDVR0OBBYEFK2eT4QnmGigLBTV\nOhRy1Y4HNNSnMAoGCCqGSM49BAMCA0gAMEUCIFd1YInyvs0sHfhlmQ59wtpDlZvv\nNdayLDFFSJ0ktvQXAiEAiMUwtWQF/U0scO2hnJTMdB5H3dj6gxmtZ7DqGQerMDE=\n-----END CERTIFICATE-----", "nonce":"'|| $nonce || '","request_uri_method":"get","authorization_request_uri": "'|| $authReqUri{uri} ||'"}'</input>
            <input name="headers">$httpHeaders</input>
        </send>
        <verify handler="ExpressionValidator" desc="Validate correct http status" stopOnError="true">
            <input name="expression">$dataReceived{response}{status} = "200"</input>
            <input name="successMessage">'The provided status code is 200.'</input>
            <input name="failureMessage">'The provided status code is not 200.'</input>
        </verify>

        <process output="authorizationRequestUri" handler="CollectionUtils" operation="find">
            <input name="map">$dataReceived{response}{headers}</input>
            <input name="value">"Authorization-Request-Uri"</input>
            <input name="ignoreCase">true()</input>
        </process>
        <log>"Presentation Request status:" || $dataReceived{response}{status}</log>
        <log>"Authorization Request URI: " || $authorizationRequestUri</log>

        <etxn txnId="t1"/>

        <interact inputTitle="Scan the QR Code" desc="Scan the QR Code with your wallet." with="wallet">
            <instruct desc="Click on the magnifying glass to display the QR code"/>
            <instruct desc="Scan this QR with your wallet" mimeType="image/png">$dataReceived{response}{body}</instruct>
            <instruct desc="After you present the credential on your wallet, click on the Close button to continue"/>
        </interact>

        <process output="transactionId" handler="CollectionUtils" operation="find">
            <input name="map">$dataReceived{response}{headers}</input>
            <input name="value">"transaction-id"</input>
            <input name="ignoreCase">true()</input>
        </process>

        <verify handler="RegExpValidator" desc="Check if transaction id exists" stopOnError="true">
            <input name="input">$transactionId</input>
            <input name="expression">".+"</input>
            <input name="successMessage">"Transaction id: " || $transactionId </input>
            <input name="failureMessage">'Transaction id value is null.'</input>
        </verify>

        <assign to="attempt" type="number">1</assign>
        <assign to="maxAttempts" type="number">$DOMAIN{maxAttempts}</assign>
        <assign to="responseStatus">'404'</assign>
        <assign to="transaction_url">$DOMAIN{endpointAddress} || "/ui/presentations/" || $transactionId</assign>
        <assign to="transaction_logs_url">$transaction_url || "/events"</assign>
        <log>$transaction_url</log>
        <log>$transaction_logs_url</log>

        <while title="Transaction logs polling" desc="Polling transaction logs from Verifier until success or timeout">
            <cond><![CDATA[$attempt <= $maxAttempts]]></cond>
            <do>
                <log>"Polling transaction logs (attempt " || $attempt || ")..."</log>
                <send id="httpRequestPoll" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
                    <input name="uri">$transaction_url</input>
                    <input name="method">"GET"</input>
                </send>
                <log>"Request status: "|| $httpRequestPoll{response}{status}</log>
                <assign to="responseStatus" source="$httpRequestPoll{response}{status}"/>
                <assign to="attempt" type="number">$attempt + 1</assign>
                <process handler="DelayProcessor" operation="delay" input="$DOMAIN{delayBetweenCalls}"/>
            </do>
        </while>

        <log>"Final response status:" || $responseStatus</log>
        <verify handler="ExpressionValidator" desc="Validate that not a success event exists for this transaction id on verifier">
            <input name="expression">$responseStatus = "400"</input>
            <input name="successMessage">'Flow is complete'</input>
            <input name="failureMessage">'Flow failed!'</input>
        </verify>

        <send id="transactionEventLogs" desc="Retrieve transaction event logs" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
            <input name="uri">$transaction_logs_url</input>
            <input name="method">"GET"</input>
        </send>

        <verify handler="$DOMAIN{validationService}" desc="Validate logs" >
            <input name="text">$transactionEventLogs{response}{body}</input>
            <input name="expectedEvent">"certificate_error"</input>
        </verify>
        <log>$transactionEventLogs{response}{body}</log>
    </steps>
    <output>
        <success>
            <default>
                "Test session succeeded."
            </default>
        </success>
        <failure>
            <default>
                "Test session failed. Refer to the failed step's report for more details."
            </default>
        </failure>
    </output>
</testcase>