<?xml version="1.0" encoding="UTF-8"?>
<testcase id="verify_pid_qr_from_custom_validator" xmlns="http://www.gitb.com/tdl/v1/" xmlns:gitb="http://www.gitb.com/core/v1/">
    <metadata>
        <gitb:name>[Example] Send PR To Verifier through custom validator</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>Send Presentation request for PID DC+SD-JWT to Verifier</gitb:description>
    </metadata>
    <actors>
        <gitb:actor id="verifier" name="Verifier" />
        <gitb:actor id="simulatedInitTransaction" name="Simulated Transaction"/>
        <gitb:actor id="wallet" name="Wallet" role="SUT"/>
    </actors>
    <steps>
        <btxn from="simulatedInitTransaction" to="verifier" txnId="t1" handler="HttpMessagingV2"/>
        <process output="nonce" handler="TokenGenerator" operation="uuid"/>

        <assign to="httpHeaders{Content-Type}">"application/json"</assign>
        <send id="dataReceived" desc="Send valid presentation request" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
            <input name="uri">$DOMAIN{endpointAddress} || "/ui/presentations"</input>
            <input name="method">"POST"</input>
            <input name="body">'{"type":"vp_token","dcql_query":{"credentials":[{"id":"query_0","format":"dc+sd-jwt","meta":{"vct_values":["urn:eudi:pid:1"]}}]},"nonce":"'|| $nonce || '","request_uri_method":"get"}'</input>
            <input name="headers">$httpHeaders</input>
        </send>
        <verify handler="ExpressionValidator" desc="Validate correct http status">
            <input name="expression">$dataReceived{response}{status} = "200"</input>
            <input name="successMessage">'The provided status code is 200.'</input>
            <input name="failureMessage">'The provided status code is not 200.'</input>
        </verify>
        <log>"Presentation Request status:" || $dataReceived{response}{status}</log>
        <log>"Presentation Request body:" || $dataReceived{response}{body}</log>

        <send id="qrCode" desc="Get Init Transaction answer from verifier" from="simulatedInitTransaction" to="verifier" handler="$DOMAIN{externalHandler}">
            <input name="data">$dataReceived{response}{body}</input>
        </send>
        <etxn txnId="t1"/>

        <process id="decodeData" handler="Base64Processor" output="png" operation="decode">
            <input name="input">$qrCode{response}{payload}</input>
        </process>

        <interact inputTitle="Scan the QR Code" desc="Scan the QR Code with your wallet." with="wallet">
            <instruct desc="QR code to scan" mimeType="image/png">$png</instruct>
        </interact>

        <process handler="JsonPointerProcessor" operation="process" output="transactionId">
            <input name="content">$dataReceived{response}{body}</input>
            <input name="pointer">"/transaction_id"</input>
        </process>

        <assign to="attempt" type="number">1</assign>
        <assign to="maxAttempts" type="number">10</assign>
        <assign to="responseStatus">'404'</assign>
        <assign to="transaction_url">$DOMAIN{endpointAddress} || "/ui/presentations/" || $transactionId</assign>
        <assign to="transaction_logs_url">$transaction_url || "/events"</assign>
        <log>$transaction_url</log>
        <log>$transaction_logs_url</log>
        <while title="HTTP Call Loop to verifier" desc="Make HTTP calls until 10 attempts or status 200">
            <cond><![CDATA[$attempt <= $maxAttempts and $responseStatus != '200']]></cond>
            <do>
                <log>"Making HTTP request (attempt " || $attempt || ")..."</log>
                <send id="httpRequestPool" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
                    <input name="uri">$transaction_url</input>
                    <input name="method">"GET"</input>
                </send>
                <log>"Request status: "|| $httpRequestPool{response}{status}</log>
                <assign to="responseStatus" source="$httpRequestPool{response}{status}"/>
                <assign to="attempt" type="number">$attempt + 1</assign>
                <process handler="DelayProcessor" operation="delay" input="2000"/> <!-- 2-second delay -->
            </do>
        </while>
        <log>"Final response status:" || $responseStatus</log>

        <verify handler="ExpressionValidator" desc="Validate if log exists for transaction id on verifier">
            <input name="expression">$responseStatus = "200"</input>
            <input name="successMessage">'Flow is complete'</input>
            <input name="failureMessage">'Flow failed!'</input>
        </verify>

        <send id="transactionEventLogs" desc="Retrieve transaction event logs" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
            <input name="uri">$transaction_logs_url</input>
            <input name="method">"GET"</input>
        </send>

        <verify handler="$DOMAIN{validationService}" desc="Validate logs with the use of external service" >
            <input name="text">$transactionEventLogs{response}{body}</input>
        </verify>

        <log>$transactionEventLogs{response}{body}</log>
    </steps>
    <output>
        <success>
            <default>
                "Test session succeeded."
            </default>
        </success>
        <failure>
            <default>
                "Test session failed. Refer to the failed step's report for more details."
            </default>
        </failure>
    </output>
</testcase>