<?xml version="1.0" encoding="UTF-8"?>
<testcase id="verify_pid_sdjwt_remote_presentation_status_list" xmlns="http://www.gitb.com/tdl/v1/" xmlns:gitb="http://www.gitb.com/core/v1/">
    <metadata>
        <gitb:name>Remote presentation of a document with its bit set on the status list</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>Remote presentation of a document with its bit set on the status list</gitb:description>
    </metadata>
    <actors>
        <gitb:actor id="verifier" name="Verifier" />
        <gitb:actor id="simulatedInitTransaction" name="Simulated Transaction"/>
        <gitb:actor id="wallet" name="Wallet" role="SUT"/>
    </actors>
    <steps>
        <btxn from="simulatedInitTransaction" to="verifier" txnId="t1" handler="HttpMessagingV2"/>
        <process output="nonce" handler="TokenGenerator" operation="uuid"/>

        <interact id="authReqUri" desc="Insert authorization request URI">
            <instruct desc='Optionally insert a custom Authorization request URI (in the format "scheme://path"). If left empty, the following value will be used: '>$DOMAIN{authUri}</instruct>
            <request name="uri" desc='Custom authorization request URI' required="false"/>
        </interact>

        <if desc="Check if variable is empty">
            <cond>string-length($authReqUri{uri}) = 0</cond>
            <then>
                <!-- Actions to take if the variable is empty -->
                <log>'Default Authorization URI'</log>
                <assign to="authReqUri{uri}">$DOMAIN{authUri}</assign>
            </then>
            <else>
                <!-- Actions to take if the variable is not empty -->
                <log>'SUT custom Authorization URI set.'</log>
            </else>
        </if>

        <assign to="httpHeaders{Content-Type}">"application/json"</assign>
        <assign to="httpHeaders{Accept}">"image/png"</assign>
        <send id="dataReceived" desc="Send valid presentation request" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
            <input name="uri">$DOMAIN{endpointAddress} || "/ui/presentations/v2"</input>
            <input name="method">"POST"</input>
            <input name="body">'{"type":"vp_token","dcql_query":{"credentials":[{"id":"query_0","format":"dc+sd-jwt","meta":{"vct_values":["urn:eudi:pid:1"]}}]},"nonce":"'|| $nonce || '","request_uri_method":"get","authorization_request_uri": "'|| $authReqUri{uri} ||'"}'</input>
            <input name="headers">$httpHeaders</input>
        </send>
        <verify handler="ExpressionValidator" desc="Validate correct http status" stopOnError="true">
            <input name="expression">$dataReceived{response}{status} = "200"</input>
            <input name="successMessage">'The provided status code is 200.'</input>
            <input name="failureMessage">'The provided status code is not 200.'</input>
        </verify>
        <log>"Presentation Request status:" || $dataReceived{response}{status}</log>
        <log>"Presentation Request body:" || $dataReceived{response}{body}</log>
        <etxn txnId="t1"/>

        <interact inputTitle="Scan the QR Code" desc="Scan the QR Code with your wallet." with="wallet">
            <instruct desc="Click on the magnifying glass to display the QR code"/>
            <instruct desc="QR code to scan" mimeType="image/png">$dataReceived{response}{body}</instruct>
            <instruct desc="After you present the credential on your wallet, click on the Close button to continue"/>
        </interact>

        <process output="transactionId" handler="CollectionUtils" operation="find">
            <input name="map">$dataReceived{response}{headers}</input>
            <input name="value">"transaction-id"</input>
            <input name="ignoreCase">true()</input>
        </process>

        <verify handler="RegExpValidator" desc="Check if transaction id exists" stopOnError="true">
            <input name="input">$transactionId</input>
            <input name="expression">".+"</input>
            <input name="successMessage">"Transaction id: " || $transactionId </input>
            <input name="failureMessage">'Transaction id value is null.'</input>
        </verify>

        <assign to="attempt" type="number">1</assign>
        <assign to="maxAttempts" type="number">$DOMAIN{maxAttempts}</assign>
        <assign to="responseStatus">'404'</assign>
        <assign to="transaction_url">$DOMAIN{endpointAddress} || "/ui/presentations/" || $transactionId</assign>
        <assign to="transaction_logs_url">$transaction_url || "/events"</assign>
        <log>$transaction_url</log>
        <log>$transaction_logs_url</log>

        <while title="HTTP Call Loop to verifier" desc="Make HTTP calls until attempts run out or status 200">
            <cond><![CDATA[$attempt <= $maxAttempts]]></cond>
            <do>
                <log>"Making HTTP request (attempt " || $attempt || ")..."</log>
                <send id="httpRequestPool" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
                    <input name="uri">$transaction_url</input>
                    <input name="method">"GET"</input>
                </send>
                <log>"Request status: "|| $httpRequestPool{response}{status}</log>
                <assign to="responseStatus" source="$httpRequestPool{response}{status}"/>
                <assign to="attempt" type="number">$attempt + 1</assign>
                <process handler="DelayProcessor" operation="delay" input="$DOMAIN{delayBetweenCalls}"/>
            </do>
        </while>

        <log>"Final response status:" || $responseStatus</log>
        <verify handler="ExpressionValidator" desc="Validate that not a success event exists for this transaction id on verifier">
            <input name="expression">$responseStatus = "400"</input>
            <input name="successMessage">'Flow is complete'</input>
            <input name="failureMessage">'Flow failed!'</input>
        </verify>

        <send id="transactionEventLogs" desc="Retrieve transaction event logs" handler="HttpMessagingV2" from="simulatedInitTransaction" to="verifier">
            <input name="uri">$transaction_logs_url</input>
            <input name="method">"GET"</input>
        </send>

        <verify handler="$DOMAIN{validationService}" desc="Validate logs" >
            <input name="text">$transactionEventLogs{response}{body}</input>
            <input name="expectedEvent">"attestation_error"</input>
        </verify>
        <log>$transactionEventLogs{response}{body}</log>
    </steps>
    <output>
        <success>
            <default>
                "Test session succeeded."
            </default>
        </success>
        <failure>
            <default>
                "Test session failed. Refer to the failed step's report for more details."
            </default>
        </failure>
    </output>
</testcase>